name: Build and Deploy Docsy Example 

on: 
  push: 
    branches: 
      - main  # Set a branch to deploy 
  pull_request: 
  workflow_dispatch:   

jobs: 
  build: 
    runs-on: ubuntu-latest 

    steps: 
      - uses: actions/checkout@v2 
        with: 
          submodules: recursive
  
      - name: Setup Hugo 
        uses: peaceiris/actions-hugo@v2 
        with: 
          hugo-version: '0.126.0' 
          extended: true 

      - name: Install Node.js 
        uses: actions/setup-node@v2 
        with: 
          node-version: '16'   

      - name: Cache npm dependencies 
        uses: actions/cache@v2 
        with: 
          path: ~/.npm 
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }} 
          restore-keys: | 
            ${{ runner.os }}-node-   

      - name: Generate package-lock.json 
        run: npm install 

      - name: Install postcss and postcss-cli 
        run: npm install postcss postcss-cli --save-dev 

      - name: Build site 
        run: hugo --minify 

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Create gh-pages-deploy branch if it doesn't exist
        run: |
          git checkout -B gh-pages-deploy
          git push origin gh-pages-deploy

      - name: Deploy to GitHub Pages
        run: |
          git config --global user.email "you@example.com"
          git config --global user.name "GitHub Actions"
          git checkout gh-pages-deploy
          rsync -av --delete-after --exclude='.git' ../public/ ./
          git add .
          git commit -m "Deploy Hugo site to GitHub Pages"
          git push origin gh-pages-deploy
        env:
          ACTIONS_DEPLOY_KEY: ${{ secrets.GH_PAT }}
